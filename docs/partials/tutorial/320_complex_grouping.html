<h1><code ng:non-bindable=""></code>
<span class="hint"></span>
</h1>
<div><p>This tutorial covers grouping with values other than count shown in the group header,
and with edit enabled.</p>

<p>We create a custom columnsProcessor to override the default aggregation that grouping sets, including
setting a custom aggregation function so that we can aggregate data from a different column than the
one we're on.</p><h2 id="Example">Example</h2>
<div class="example"><h4>Source</h4>
<div source-edit="app" source-edit-deps="angular.js app.js" source-edit-html="index.html-97" source-edit-css="main.css" source-edit-js="app.js" source-edit-unit="" source-edit-scenario="scenario.js-98"></div>
<div class="tabbable"><div class="tab-pane" title="index.html">
<pre class="prettyprint linenums" ng-set-text="index.html-97" ng-html-wrap-loaded="app angular.js app.js"></pre>
<script type="text/ng-template" id="index.html-97">
  <div ng-controller="MainCtrl">
    <div id="grid1" ui-grid="gridOptions" ui-grid-grouping ui-grid-edit class="grid"></div>
  </div>
</script>
</div>
<div class="tab-pane" title="main.css">
<pre class="prettyprint linenums" ng-set-text="main.css"></pre>
<style type="text/css" id="main.css">
  .grid {
    width: 500px;
    height: 400px;
  }
</style>
</div>
<div class="tab-pane" title="app.js">
<pre class="prettyprint linenums" ng-set-text="app.js"></pre>
<script type="text/ng-template" id="app.js">
  var app = angular.module('app', ['ngAnimate', 'ngTouch', 'ui.grid', 'ui.grid.grouping', 'ui.grid.edit' ]);

  app.controller('MainCtrl', ['$scope', '$http', '$interval', 'uiGridGroupingConstants', '$filter', function ($scope, $http, $interval, uiGridGroupingConstants, $filter ) {
    var setGroupValues = function( columns, rows ) {
      columns.forEach( function( column ) {
        if ( column.grouping && column.grouping.groupPriority > -1 ){
          column.treeAggregation.type = uiGridGroupingConstants.aggregation.CUSTOM;
          column.customTreeAggregationFn = function( aggregation, fieldValue, numValue, row ) {
            if ( typeof(aggregation.value) === 'undefined') {
              aggregation.value = 0;
            }
            aggregation.value = aggregation.value + row.entity.balance;
          };
          column.customTreeAggregationFinalizerFn = function( aggregation ) {
            if ( typeof(aggregation.groupVal) !== 'undefined') {
              aggregation.rendered = aggregation.groupVal + ' (' + $filter('currency')(aggregation.value) + ')';
            } else {
              aggregation.rendered = null;
            }
          };
        } else {
          delete column.customTreeAggregationFn;
        }
      });
      return columns;
    };

    $scope.gridOptions = {
      enableFiltering: true,
      columnDefs: [
        { name: 'name', width: '30%' },
        { name: 'gender', grouping: { groupPriority: 1 }, sort: { priority: 1, direction: 'asc' }, editableCellTemplate: 'ui-grid/dropdownEditor', width: '20%',
          cellFilter: 'mapGender', editDropdownValueLabel: 'gender', editDropdownOptionsArray: [
            { id: 1, gender: 'male' },
            { id: 2, gender: 'female' }
          ] 
        },
        { name: 'age', treeAggregation: { type: uiGridGroupingConstants.aggregation.MAX }, width: '20%' },
        { name: 'company', width: '25%' },
        { name: 'state', grouping: { groupPriority: 0 }, sort: { priority: 0, direction: 'desc' }, width: '35%', cellTemplate: '<div><div ng-if="!col.grouping || col.grouping.groupPriority === undefined || col.grouping.groupPriority === null || ( row.groupHeader && col.grouping.groupPriority === row.treeLevel )" class="ui-grid-cell-contents" title="TOOLTIP">{{COL_FIELD CUSTOM_FILTERS}}</div></div>' },
        { name: 'balance', width: '25%', cellFilter: 'currency', treeAggregation: { type: uiGridGroupingConstants.aggregation.AVG }, customTreeAggregationFinalizerFn: function( aggregation ) { 
          aggregation.rendered = aggregation.value; 
        } }
      ],
      onRegisterApi: function( gridApi ) {
        $scope.gridApi = gridApi;
        $scope.gridApi.grid.registerColumnsProcessor( setGroupValues, 410 );
      }
    };

    $http.get('/data/500_complex.json')
    .success(function(data) {
      for ( var i = 0; i < data.length; i++ ){
        data[i].state = data[i].address.state;
        data[i].gender = data[i].gender === 'male' ? 1: 2;
        data[i].balance = Number( data[i].balance.slice(1).replace(/,/,'') );
      }
      delete data[2].age;
      $scope.gridOptions.data = data;
    });

  }])
  .filter('mapGender', function() {
    var genderHash = {
      1: 'male',
      2: 'female'
    };

    return function(input) {
      var result;
      var match;
      if (!input){
        return '';
      } else if (result = genderHash[input]) {
        return result;
      } else if ( ( match = input.match(/(.+)( \([$\d,.]+\))/) ) && ( result = genderHash[match[1]] ) ) {
        return result + match[2];
      } else {
        return input;
      }
    };
  });
</script>
</div>
<div class="tab-pane" title="End to end test">
<pre class="prettyprint linenums" ng-set-text="scenario.js-98"></pre>
<script type="text/ng-template" id="scenario.js-98">
  var gridTestUtils = require('../../test/e2e/gridTestUtils.spec.js');
  describe( '209 grouping', function() {
  });
</script>
</div>
</div><h4>Demo</h4>
<div class="well doc-example-live animator-container" ng-embed-app="app" ng-set-html="index.html-97" ng-eval-javascript="app.js"></div></div>
</div>
